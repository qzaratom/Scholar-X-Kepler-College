<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Session Management - ScholarX Instructor</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #1A1F36;
            --primary-dark: #1A1F36;
            --secondary: #1A1F36;
            --accent: #00C9B7;
            --light: #F8FAFC;
            --gray-light: #E2E8F0;
            --gray: #94A3B8;
            --gray-dark: #64748B;
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --sidebar-width: 260px;
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --radius: 12px;
            --radius-sm: 8px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background-color: #F8FAFC;
            color: #334155;
            line-height: 1.6;
            display: flex;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* NEW: Top Bar */
        .top-bar {
            position: fixed;
            top: 0;
            left: var(--sidebar-width);
            right: 0;
            height: 70px;
            background: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            display: flex;
            align-items: center;
            padding: 0 30px;
            z-index: 99;
        }

        .top-bar h1 {
            font-size: 22px;
            font-weight: 700;
            color: var(--secondary);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .top-bar h1 i {
            color: var(--primary);
            font-size: 24px;
        }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: linear-gradient(180deg, var(--secondary) 0%, #0F172A 100%);
            color: white;
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            left: 0;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-lg);
            transition: var(--transition);
        }

        .sidebar-header {
            padding: 24px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .app-logo {
            height: 40px;
            width: auto;
            object-fit: contain;
        }

        .app-name {
            font-size: 24px;
            font-weight: 700;
            color: white;
        }

        .instructor-badge {
            background: rgba(74, 111, 255, 0.15);
            color: var(--primary);
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 20px;
            margin-top: 4px;
            display: inline-block;
        }

        .sidebar-nav {
            flex: 1;
            padding: 24px 0;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 14px 20px;
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
            transition: var(--transition);
            margin: 4px 12px;
            border-radius: var(--radius-sm);
            font-weight: 500;
            cursor: pointer;
            border: none;
            background: none;
            width: calc(100% - 24px);
            text-align: left;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.08);
            color: white;
            transform: translateX(4px);
        }

        .nav-item.active {
            background: rgba(74, 111, 255, 0.15);
            color: white;
            border-left: 4px solid var(--primary);
        }

        .nav-item i {
            margin-right: 12px;
            width: 20px;
            text-align: center;
            font-size: 18px;
        }

        .sidebar-footer {
            padding: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.08);
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .profile-pic {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--primary);
        }

        .profile-info h4 {
            font-size: 15px;
            font-weight: 600;
            color: white;
        }

        .profile-info p {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
        }

        .logout-btn {
            width: 100%;
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            border: 1px solid rgba(239, 68, 68, 0.2);
            padding: 12px;
            border-radius: var(--radius-sm);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .logout-btn:hover {
            background: rgba(239, 68, 68, 0.2);
        }

        /* Main Content */
        .main-content {
            margin-left: var(--sidebar-width);
            flex: 1;
            padding: 30px;
            padding-top: 90px; /* Account for top bar */
            transition: var(--transition);
        }

        /* NEW: Feature Buttons Grid */
        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .feature-card {
            background: white;
            border-radius: var(--radius);
            padding: 25px;
            box-shadow: var(--shadow);
            transition: var(--transition);
            border: 1px solid var(--gray-light);
            position: relative;
            cursor: pointer;
        }

        .feature-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary);
        }

        .feature-card.recommendations {
            border-top: 4px solid var(--success);
        }

        .feature-card.feedbacks {
            border-top: 4px solid var(--primary);
        }

        .feature-card.multiple-choice {
            border-top: 4px solid var(--warning);
        }

        .feature-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            margin-bottom: 15px;
        }

        .feature-icon.recommendations {
            background: linear-gradient(135deg, var(--success) 0%, #22C55E 100%);
        }

        .feature-icon.feedbacks {
            background: linear-gradient(135deg, var(--primary) 0%, #6C8BFF 100%);
        }

        .feature-icon.multiple-choice {
            background: linear-gradient(135deg, var(--warning) 0%, #FBBF24 100%);
        }

        .feature-content h3 {
            font-size: 18px;
            font-weight: 700;
            color: var(--secondary);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .feature-content p {
            color: var(--gray-dark);
            font-size: 14px;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .notification-badge {
            background: var(--danger);
            color: white;
            font-size: 12px;
            font-weight: 700;
            padding: 3px 8px;
            border-radius: 20px;
            min-width: 24px;
            text-align: center;
        }

        .feature-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            color: var(--gray-dark);
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--gray-light);
        }

        /* Compact Login Section */
        .login-section {
            background: white;
            border-radius: var(--radius);
            padding: 30px;
            box-shadow: var(--shadow);
            max-width: 500px;
            margin: 0 auto;
        }

        .welcome-card {
            text-align: center;
            margin-bottom: 20px;
        }

        .welcome-icon {
            font-size: 48px;
            color: var(--primary);
            margin-bottom: 15px;
        }

        .welcome-card h2 {
            font-size: 22px;
            color: var(--secondary);
            margin-bottom: 8px;
        }

        .welcome-card p {
            color: var(--gray-dark);
            margin-bottom: 15px;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--secondary);
            font-size: 14px;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--gray-light);
            border-radius: var(--radius-sm);
            font-size: 14px;
            transition: var(--transition);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(74, 111, 255, 0.1);
        }

        .error-message {
            background-color: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            padding: 10px 14px;
            border-radius: var(--radius-sm);
            margin-bottom: 15px;
            display: none;
            font-size: 13px;
            border-left: 4px solid var(--danger);
        }

        .success-message {
            background-color: rgba(16, 185, 129, 0.1);
            color: var(--success);
            padding: 10px 14px;
            border-radius: var(--radius-sm);
            margin-bottom: 15px;
            display: none;
            font-size: 13px;
            border-left: 4px solid var(--success);
        }

        .remember-me {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 15px 0;
            color: var(--gray-dark);
            font-size: 14px;
            cursor: pointer;
        }

        .remember-me input {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border-radius: var(--radius-sm);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            border: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 12px rgba(74, 111, 255, 0.25);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(74, 111, 255, 0.3);
        }

        .btn-secondary {
            background: white;
            color: var(--secondary);
            border: 1px solid var(--gray-light);
        }

        .btn-secondary:hover {
            background: var(--light);
            border-color: var(--gray);
        }

        .btn-full {
            width: 100%;
            padding: 14px;
        }

        .btn-logout-system {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .btn-logout-system:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
        }

        /* Stats Cards */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: var(--radius);
            padding: 24px;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .stat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            color: white;
        }

        .stat-icon.system {
            background: linear-gradient(135deg, var(--primary) 0%, #6C8BFF 100%);
        }

        .stat-icon.session {
            background: linear-gradient(135deg, var(--accent) 0%, #2CE0D0 100%);
        }

        .stat-icon.points {
            background: linear-gradient(135deg, var(--success) 0%, #22C55E 100%);
        }

        .stat-icon.feedback {
            background: linear-gradient(135deg, var(--warning) 0%, #FBBF24 100%);
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--secondary);
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 14px;
            color: var(--gray-dark);
            font-weight: 500;
        }

        /* Current System Info */
        .current-system-info {
            background: linear-gradient(135deg, var(--primary) 0%, #3A5BDF 100%);
            color: white;
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
        }

        .system-info-content h3 {
            font-size: 20px;
            margin-bottom: 5px;
            font-weight: 700;
        }

        .system-info-content p {
            opacity: 0.9;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .instructor-info {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.15);
            padding: 8px 15px;
            border-radius: 20px;
        }

        .page-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 30px;
        }

        .page-title h1 {
            font-size: 28px;
            font-weight: 700;
            color: var(--secondary);
            margin-bottom: 8px;
        }

        .page-title p {
            color: var(--gray-dark);
            font-size: 16px;
        }

        .header-actions {
            display: flex;
            gap: 16px;
        }

        /* NEW: Feature Modals */
        .feature-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(15, 23, 42, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
            backdrop-filter: blur(4px);
        }

        .feature-modal.active {
            display: flex;
        }

        .feature-modal-content {
            background: white;
            border-radius: var(--radius);
            width: 100%;
            max-width: 800px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            animation: modalFadeIn 0.3s ease-out;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .feature-modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--gray-light);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            background: white;
            z-index: 1;
        }

        .feature-modal-header h2 {
            font-size: 20px;
            font-weight: 700;
            color: var(--secondary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 20px;
            color: var(--gray);
            cursor: pointer;
            transition: var(--transition);
        }

        .close-modal:hover {
            color: var(--danger);
        }

        .feature-modal-body {
            padding: 24px;
        }

        /* Recommendations Styles */
        .recommendation-card {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(16, 185, 129, 0.05) 100%);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .recommendation-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
        }

        .recommendation-header i {
            color: var(--success);
            font-size: 22px;
        }

        .recommendation-header h3 {
            font-size: 18px;
            color: var(--secondary);
            font-weight: 700;
        }

        .issue-stats {
            background: white;
            border-radius: var(--radius-sm);
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid var(--gray-light);
        }

        .issue-stats h4 {
            font-size: 16px;
            color: var(--secondary);
            margin-bottom: 10px;
        }

        .recommendations-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .recommendation-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px;
            background: white;
            border-radius: var(--radius-sm);
            border: 1px solid var(--gray-light);
        }

        .recommendation-item i {
            color: var(--success);
            margin-top: 3px;
        }

        /* Feedback Summary Styles */
        .feedback-summary {
            margin-bottom: 25px;
        }

        .feedback-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 16px;
            background: var(--light);
            border: 1px solid var(--gray-light);
            border-radius: 20px;
            color: var(--gray-dark);
            font-size: 13px;
            cursor: pointer;
            transition: var(--transition);
        }

        .filter-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .filter-btn:hover:not(.active) {
            border-color: var(--primary);
            color: var(--primary);
        }

        .feedback-stats {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .feedback-stat-item {
            background: var(--light);
            border-radius: var(--radius-sm);
            padding: 15px;
            text-align: center;
        }

        .feedback-stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .feedback-stat-label {
            font-size: 12px;
            color: var(--gray-dark);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .feedback-item {
            background: white;
            border-radius: var(--radius-sm);
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid var(--gray-light);
            transition: var(--transition);
        }

        .feedback-item:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow);
        }

        .feedback-session {
            font-size: 12px;
            color: var(--primary);
            background: rgba(74, 111, 255, 0.1);
            padding: 3px 8px;
            border-radius: 12px;
            display: inline-block;
            margin-bottom: 8px;
        }

        /* Multiple Choice Ranking Styles */
        .ranking-chart {
            margin-bottom: 25px;
        }

        .ranking-item {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .ranking-position {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            margin-right: 15px;
            flex-shrink: 0;
        }

        .ranking-position.gold {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
        }

        .ranking-position.silver {
            background: linear-gradient(135deg, #C0C0C0 0%, #A9A9A9 100%);
        }

        .ranking-position.bronze {
            background: linear-gradient(135deg, #CD7F32 0%, #8B4513 100%);
        }

        .ranking-content {
            flex: 1;
        }

        .ranking-bar {
            height: 24px;
            background: var(--gray-light);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 5px;
        }

        .ranking-fill {
            height: 100%;
            background: var(--primary);
            border-radius: 12px;
            transition: width 1s ease-in-out;
        }

        .ranking-info {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            color: var(--gray-dark);
        }

        /* Sessions Grid */
        .sessions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .session-card {
            background: white;
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--gray-light);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .session-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .session-card.locked::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--gray);
        }

        .session-card.unlocked::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--success);
        }

        .session-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .session-header h3 {
            font-size: 16px;
            font-weight: 700;
            color: var(--secondary);
            margin-bottom: 4px;
        }

        .session-number {
            font-size: 12px;
            color: var(--gray-dark);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .session-badge {
            font-size: 11px;
            font-weight: 600;
            padding: 3px 8px;
            border-radius: 20px;
        }

        .session-badge.locked {
            background: rgba(100, 116, 139, 0.1);
            color: var(--gray-dark);
        }

        .session-badge.unlocked {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .session-details {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
            min-width: 60px;
        }

        .detail-value {
            font-size: 16px;
            font-weight: 700;
            color: var(--secondary);
        }

        .detail-label {
            font-size: 11px;
            color: var(--gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .session-actions {
            display: flex;
            gap: 6px;
        }

        .btn-sm {
            padding: 6px 10px;
            font-size: 12px;
            border-radius: 6px;
            flex: 1;
            min-width: 60px;
        }

        .btn-unlock {
            background: var(--success);
            color: white;
        }

        .btn-lock {
            background: var(--gray);
            color: white;
        }

        .btn-view {
            background: var(--primary);
            color: white;
        }

        .btn-unlock:disabled,
        .btn-lock:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        /* Charts */
        .chart-container {
            background: white;
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 25px;
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .chart-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--secondary);
        }
        
        .chart-wrapper {
            position: relative;
            height: 300px;
            width: 100%;
        }
        
        .chart-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
            padding: 10px;
            background: var(--light);
            border-radius: var(--radius-sm);
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }
        
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        .student-name {
            font-weight: 500;
            color: var(--secondary);
        }
        
        .rating-value {
            color: var(--primary);
            font-weight: 600;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--secondary);
            color: white;
            padding: 12px 18px;
            border-radius: var(--radius-sm);
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 3000;
            transform: translateY(100px);
            opacity: 0;
            transition: var(--transition);
            max-width: 350px;
            font-size: 14px;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.success {
            background: var(--success);
        }

        .toast.error {
            background: var(--danger);
        }

        /* Mobile Menu Toggle */
        .menu-toggle {
            display: none;
            position: fixed;
            top: 15px;
            right: 15px;
            z-index: 1001;
            background: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: var(--radius-sm);
            box-shadow: var(--shadow);
            font-size: 18px;
            color: var(--secondary);
            cursor: pointer;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                width: 250px;
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .top-bar {
                left: 0;
            }
            
            .main-content {
                margin-left: 0;
                padding: 20px;
                padding-top: 80px;
            }
            
            .page-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .header-actions {
                width: 100%;
                justify-content: space-between;
            }
            
            .features-grid {
                grid-template-columns: 1fr;
            }
            
            .sessions-grid {
                grid-template-columns: 1fr;
            }
            
            .session-actions {
                flex-direction: row;
            }
            
            .current-system-info {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .menu-toggle {
                display: block;
            }
        }

        @media (max-width: 576px) {
            .stats-container {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .stat-card {
                padding: 20px;
            }
            
            .stat-value {
                font-size: 28px;
            }
            
            .login-section {
                padding: 20px;
            }
            
            .feature-modal-content {
                max-width: 95%;
                max-height: 90vh;
            }
            
            .feedback-stats {
                grid-template-columns: 1fr 1fr;
            }
            
            .btn {
                padding: 10px 15px;
                font-size: 14px;
            }
        }

        @media (max-width: 400px) {
            .main-content {
                padding: 15px;
                padding-top: 70px;
            }
            
            .page-title h1 {
                font-size: 24px;
            }
            
            .session-details {
                gap: 10px;
            }
            
            .detail-item {
                min-width: 50px;
            }
            
            .detail-value {
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <!-- Mobile Menu Toggle -->
    <button class="menu-toggle" id="menuToggle">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <img src="logo.png" alt="ScholarX Logo" class="app-logo">
            <div>
                <div class="app-name">ScholarX</div>
                <div class="instructor-badge">Instructor Portal</div>
            </div>
        </div>

        <nav class="sidebar-nav">
            <button class="nav-item" onclick="navigateToInstructorDashboard()">
                <i class="fas fa-chart-line"></i>
                <span>Dashboard</span>
            </button>
            <button class="nav-item" onclick="navigateToSuggestionBox()">
                <i class="fas fa-lightbulb"></i>
                <span>Suggestion Box</span>
            </button>
            <button class="nav-item active" onclick="navigateToRatingManagement()">
                <i class="fas fa-star"></i>
                <span>Rating & Feedback</span>
            </button>
            <button class="nav-item" onclick="navigateToLearningHub()">
                <i class="fas fa-book-open"></i>
                <span>Learning HUB</span>
            </button>
            <button class="nav-item" onclick="navigateToSettings()">
                <i class="fas fa-cog"></i>
                <span>Settings</span>
            </button>
        </nav>

        <div class="sidebar-footer">
            <div class="user-profile">
                <img id="profilePicture" src="default-instructor.png" alt="Profile" class="profile-pic">
                <div class="profile-info">
                    <h4 id="instructorName">Not Logged In</h4>
                    <p id="instructorRole">Select System</p>
                </div>
            </div>
            <button class="logout-btn" onclick="logoutInstructor()">
                <i class="fas fa-sign-out-alt"></i>
                <span>Logout</span>
            </button>
        </div>
    </aside>

    <!-- NEW: Top Bar -->
    <div class="top-bar">
        <h1>
            <i class="fas fa-star"></i>
            Instructor Rating & Feedback System
        </h1>
    </div>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Login Interface -->
        <div id="loginInterface">
            <div class="login-section">
                <div class="welcome-card">
                    <div class="welcome-icon">
                        <i class="fas fa-chalkboard-teacher"></i>
                    </div>
                    <h2>Welcome to ScholarX Instructor Portal</h2>
                    <p>Please select your rating system and enter your instructor passcode to continue</p>
                </div>

                <div class="error-message" id="errorMessage"></div>
                <div class="success-message" id="successMessage"></div>

                <div class="form-group">
                    <label class="form-label">Select Rating System *</label>
                    <select id="systemSelect" class="form-control">
                        <option value="">-- Select a System --</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Instructor Passcode *</label>
                    <input type="password" id="codeInput" class="form-control" placeholder="Enter your instructor passcode">
                    <small style="color: var(--gray); display: block; margin-top: 6px; font-size: 12px;">
                        <i class="fas fa-info-circle"></i> Your instructor passcode was provided by your administrator
                    </small>
                </div>

                <div class="remember-me">
                    <input type="checkbox" id="rememberMe">
                    <label for="rememberMe">Keep me logged in to this system</label>
                </div>

                <button class="btn btn-primary btn-full" onclick="loginInstructor()">
                    <i class="fas fa-sign-in-alt"></i>
                    <span>Access System</span>
                </button>

                <div style="text-align: center; margin-top: 15px; color: var(--gray); font-size: 13px;">
                    <p>Need help? Contact your administrator</p>
                </div>
            </div>
        </div>

        <!-- Session Management Interface -->
        <div id="sessionManagement" style="display: none;">
            <!-- Current System Info -->
            <div class="current-system-info">
                <div class="system-info-content">
                    <h3 id="currentSystemTitle">System Name</h3>
                    <p id="currentCourseName">Course Name</p>
                    <div class="instructor-info">
                        <i class="fas fa-user-tie"></i>
                        <span id="currentInstructorName">Instructor Name</span>
                    </div>
                </div>
                <button class="btn btn-logout-system" onclick="logoutCurrentSystem()">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Exit System</span>
                </button>
            </div>

            <div class="page-header">
                <div class="page-title">
                    <h1>Rating & Feedback Dashboard</h1>
                    <p>Manage sessions and analyze student feedback</p>
                </div>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="refreshData()">
                        <i class="fas fa-sync-alt"></i>
                        <span>Refresh</span>
                    </button>
                    <button class="btn btn-primary" onclick="openFeedbackModal()">
                        <i class="fas fa-chart-bar"></i>
                        <span>Session Analytics</span>
                    </button>
                </div>
            </div>

            <!-- NEW: Feature Buttons Grid -->
            <div class="features-grid" id="featuresGrid">
                <!-- Features populated by JavaScript -->
            </div>

            <!-- Stats -->
            <div class="stats-container" id="statsContainer">
                <!-- Stats populated by JavaScript -->
            </div>

            <!-- Ratings Overview with Line Graphs -->
            <div class="chart-container">
                <div class="chart-header">
                    <h3 class="chart-title">Student Rating Trends</h3>
                    <div style="display: flex; gap: 10px;">
                        <select id="chartFilter" class="form-control" style="width: auto; padding: 8px 12px; font-size: 13px;" onchange="updateChart()">
                            <option value="all">All Sessions</option>
                            <option value="last5">Last 5 Sessions</option>
                            <option value="last3">Last 3 Sessions</option>
                        </select>
                    </div>
                </div>
                <div class="chart-wrapper">
                    <canvas id="ratingsChart"></canvas>
                </div>
                <div class="chart-legend" id="chartLegend">
                    <!-- Legend populated by JavaScript -->
                </div>
            </div>

            <!-- Sessions Grid -->
            <div style="margin-bottom: 20px;">
                <h2 style="font-size: 20px; color: var(--secondary); margin-bottom: 8px;">Course Sessions</h2>
                <p style="color: var(--gray-dark); font-size: 14px;">Manage session access for students</p>
            </div>

            <div class="sessions-grid" id="sessionsContainer">
                <!-- Sessions populated by JavaScript -->
            </div>
        </div>
    </main>

    <!-- NEW: Recommendations Modal -->
    <div id="recommendationsModal" class="feature-modal">
        <div class="feature-modal-content">
            <div class="feature-modal-header">
                <h2>
                    <i class="fas fa-lightbulb"></i>
                    Recommendations
                    <span class="notification-badge" id="recommendationsCount">0</span>
                </h2>
                <button class="close-modal" onclick="closeRecommendationsModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="feature-modal-body" id="recommendationsContent">
                <!-- Recommendations content populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- NEW: Feedbacks Modal -->
    <div id="feedbacksModal" class="feature-modal">
        <div class="feature-modal-content">
            <div class="feature-modal-header">
                <h2>
                    <i class="fas fa-comments"></i>
                    All Feedback
                    <span class="notification-badge" id="feedbacksCount">0</span>
                </h2>
                <button class="close-modal" onclick="closeFeedbacksModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="feature-modal-body" id="feedbacksContent">
                <!-- Feedbacks content populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- NEW: Multiple Choice Modal -->
    <div id="multipleChoiceModal" class="feature-modal">
        <div class="feature-modal-content">
            <div class="feature-modal-header">
                <h2>
                    <i class="fas fa-poll"></i>
                    Multiple Choice Rankings
                </h2>
                <button class="close-modal" onclick="closeMultipleChoiceModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="feature-modal-body" id="multipleChoiceContent">
                <!-- Multiple choice content populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Existing Feedback Modal -->
    <div id="feedbackModal" class="feature-modal">
        <div class="feature-modal-content">
            <div class="feature-modal-header">
                <h2>Feedback Analytics</h2>
                <button class="close-modal" onclick="closeFeedbackModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="feature-modal-body">
                <div class="session-tabs" id="sessionTabs">
                    <!-- Session tabs populated by JavaScript -->
                </div>
                <div id="feedbackContent">
                    <!-- Feedback content populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast">
        <i class="fas fa-check-circle"></i>
        <span id="toastMessage">Operation completed successfully!</span>
    </div>

    <script>
        // Global variables
        let ratingSystems = [];
        let currentInstructor = null;
        let currentSystemIndex = null;
        let currentSessionIndex = 0;
        let ratingsChart = null;
        let userProfileData = {
            name: '',
            profilePic: 'default-instructor.png',
            role: 'Instructor'
        };

        // Persistent sessions storage
        const CURRENT_SESSION_KEY = 'instructorCurrentSession';

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Load rating systems
            ratingSystems = JSON.parse(localStorage.getItem('ratingSystems') || '[]');
            
            // Load user profile
            loadUserProfile();
            
            // Populate system select
            populateSystemSelect();
            
            // Setup mobile menu toggle
            document.getElementById('menuToggle').addEventListener('click', toggleSidebar);
            
            // Close sidebar when clicking outside on mobile
            document.addEventListener('click', function(event) {
                const sidebar = document.getElementById('sidebar');
                const menuToggle = document.getElementById('menuToggle');
                
                if (window.innerWidth <= 768 && 
                    !sidebar.contains(event.target) && 
                    !menuToggle.contains(event.target) && 
                    sidebar.classList.contains('active')) {
                    sidebar.classList.remove('active');
                }
            });
            
            // Enter key to submit login form
            document.getElementById('codeInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    loginInstructor();
                }
            });
            
            // Check for persistent session on page load
            checkPersistentSession();
        });

        // Check for persistent session
        function checkPersistentSession() {
            const currentSession = JSON.parse(localStorage.getItem(CURRENT_SESSION_KEY) || 'null');
            
            if (currentSession) {
                const now = new Date();
                const sessionDate = new Date(currentSession.loginTime);
                const hoursDiff = (now - sessionDate) / (1000 * 60 * 60);
                
                if (hoursDiff < 24 && currentSession.rememberMe) {
                    autoLoginFromSession(currentSession);
                } else {
                    showLoginInterface();
                    localStorage.removeItem(CURRENT_SESSION_KEY);
                }
            } else {
                showLoginInterface();
            }
        }

        // Auto-login from stored session
        function autoLoginFromSession(sessionData) {
            const systemIndex = sessionData.systemIndex;
            const instructorCode = sessionData.instructorCode;
            
            if (ratingSystems[systemIndex]) {
                const system = ratingSystems[systemIndex];
                const instructor = system.instructors.find(i => i.code.toLowerCase() === instructorCode.toLowerCase());
                
                if (instructor) {
                    currentInstructor = instructor;
                    currentSystemIndex = parseInt(systemIndex);
                    
                    sessionStorage.setItem('instructorSession', JSON.stringify({
                        systemIndex: currentSystemIndex,
                        instructor: instructor
                    }));
                    
                    userProfileData.name = instructor.name;
                    userProfileData.role = `${system.courseName} Instructor`;
                    updateProfileSidebar();
                    saveUserProfile();
                    
                    showSessionManagement(system);
                    updateCurrentSystemInfo(system, instructor);
                    
                    showToast(`Welcome back, ${instructor.name}!`, 'success');
                } else {
                    showLoginInterface();
                    localStorage.removeItem(CURRENT_SESSION_KEY);
                }
            } else {
                showLoginInterface();
                localStorage.removeItem(CURRENT_SESSION_KEY);
            }
        }

        // Show login interface
        function showLoginInterface() {
            document.getElementById('loginInterface').style.display = 'block';
            document.getElementById('sessionManagement').style.display = 'none';
            
            document.getElementById('codeInput').value = '';
            document.getElementById('rememberMe').checked = false;
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';
        }

        // Update current system info display
        function updateCurrentSystemInfo(system, instructor) {
            document.getElementById('currentSystemTitle').textContent = system.systemName;
            document.getElementById('currentCourseName').textContent = system.courseName;
            document.getElementById('currentInstructorName').textContent = instructor.name;
        }

        // Load user profile
        function loadUserProfile() {
            const savedProfile = JSON.parse(localStorage.getItem('instructorProfile') || 'null');
            
            if (savedProfile) {
                userProfileData = savedProfile;
            } else {
                const sessionData = JSON.parse(sessionStorage.getItem('instructorSession') || 'null');
                if (sessionData && sessionData.instructor) {
                    userProfileData.name = sessionData.instructor.name;
                    userProfileData.role = 'Instructor';
                }
            }
            
            updateProfileSidebar();
        }

        // Update profile in sidebar
        function updateProfileSidebar() {
            document.getElementById('instructorName').textContent = userProfileData.name || 'Not Logged In';
            document.getElementById('instructorRole').textContent = userProfileData.role || 'Select System';
            
            if (userProfileData.profilePic) {
                document.getElementById('profilePicture').src = userProfileData.profilePic;
            }
        }

        // Toggle sidebar on mobile
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('active');
        }

        // Navigation functions
        function navigateToInstructorDashboard() { 
            saveUserProfile();
            window.location.href = 'instructordash.html'; 
        }
        
        function navigateToRatingManagement() { 
            // Already on this page
        }

        function navigateToSuggestionBox() { 
            saveUserProfile();
            window.location.href = 'instructorbox.html'; 
        }
        
        function navigateToLearningHub() { 
            saveUserProfile();
            window.location.href = 'instructorLH.html'; 
        }
        
        function navigateToSettings() { 
            saveUserProfile();
            window.location.href = 'settingI.html'; 
        }

        // Save user profile
        function saveUserProfile() {
            if (currentInstructor) {
                userProfileData.name = currentInstructor.name;
                userProfileData.role = `${ratingSystems[currentSystemIndex].courseName} Instructor`;
                
                const dashboardProfile = JSON.parse(localStorage.getItem('dashboardProfile') || 'null');
                const settingsProfile = JSON.parse(localStorage.getItem('settingsProfile') || 'null');
                
                if (settingsProfile && settingsProfile.profilePic) {
                    userProfileData.profilePic = settingsProfile.profilePic;
                } else if (dashboardProfile && dashboardProfile.profilePic) {
                    userProfileData.profilePic = dashboardProfile.profilePic;
                }
                
                localStorage.setItem('instructorProfile', JSON.stringify(userProfileData));
            }
        }

        // Populate system select dropdown
        function populateSystemSelect() {
            const select = document.getElementById('systemSelect');
            select.innerHTML = '<option value="">-- Select a System --</option>';
            
            ratingSystems.forEach((system, index) => {
                if (system.instructors && system.instructors.length > 0) {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = `${system.systemName} - ${system.courseName}`;
                    select.appendChild(option);
                }
            });
            
            if (ratingSystems.length === 0) {
                const option = document.createElement('option');
                option.value = "";
                option.textContent = "No rating systems available";
                option.disabled = true;
                select.appendChild(option);
            }
        }

        // Show toast notification
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            
            toastMessage.textContent = message;
            toast.className = 'toast' + (type === 'error' ? ' error' : '');
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Login instructor
        function loginInstructor() {
            const systemIndex = document.getElementById('systemSelect').value;
            const code = document.getElementById('codeInput').value.trim();
            const rememberMe = document.getElementById('rememberMe').checked;
            const errorMsg = document.getElementById('errorMessage');
            const successMsg = document.getElementById('successMessage');
            
            errorMsg.style.display = 'none';
            successMsg.style.display = 'none';
            
            if (!systemIndex) {
                errorMsg.textContent = 'Please select a rating system';
                errorMsg.style.display = 'block';
                return;
            }
            
            if (!code) {
                errorMsg.textContent = 'Please enter your instructor passcode';
                errorMsg.style.display = 'block';
                return;
            }
            
            const system = ratingSystems[systemIndex];
            const instructor = system.instructors.find(i => i.code.toLowerCase() === code.toLowerCase());
            
            if (!instructor) {
                errorMsg.textContent = 'Invalid instructor passcode for this system. Please check your code and try again.';
                errorMsg.style.display = 'block';
                return;
            }
            
            currentInstructor = instructor;
            currentSystemIndex = parseInt(systemIndex);
            
            sessionStorage.setItem('instructorSession', JSON.stringify({
                systemIndex: currentSystemIndex,
                instructor: instructor
            }));
            
            if (rememberMe) {
                localStorage.setItem(CURRENT_SESSION_KEY, JSON.stringify({
                    systemIndex: currentSystemIndex,
                    instructorCode: instructor.code,
                    loginTime: new Date().toISOString(),
                    rememberMe: true
                }));
            } else {
                localStorage.removeItem(CURRENT_SESSION_KEY);
            }
            
            userProfileData.name = instructor.name;
            userProfileData.role = `${system.courseName} Instructor`;
            updateProfileSidebar();
            saveUserProfile();
            
            showSessionManagement(system);
            updateCurrentSystemInfo(system, instructor);
            
            successMsg.textContent = `Welcome back, ${instructor.name}!`;
            successMsg.style.display = 'block';
            
            document.getElementById('codeInput').value = '';
            
            showToast(`Logged in as ${instructor.name}`, 'success');
        }

        // Show session management interface
        function showSessionManagement(system) {
            document.getElementById('loginInterface').style.display = 'none';
            document.getElementById('sessionManagement').style.display = 'block';
            
            loadSessionManagement(system);
            initializeRatingsChart(system);
        }

        // Logout from current system only
        function logoutCurrentSystem() {
            if (confirm('Are you sure you want to logout from this system?')) {
                currentInstructor = null;
                currentSystemIndex = null;
                
                localStorage.removeItem(CURRENT_SESSION_KEY);
                
                showLoginInterface();
                
                if (ratingsChart) {
                    ratingsChart.destroy();
                    ratingsChart = null;
                }
                
                showToast('Logged out from system successfully', 'success');
            }
        }

        // Load session management data
        function loadSessionManagement(system) {
            const totalSessions = system.sessions.length;
            const status = getSessionStatus(currentSystemIndex);
            const unlockedSessions = Object.values(status).filter(v => v === true).length;
            
            const allFeedback = JSON.parse(localStorage.getItem('studentFeedback') || '[]');
            const systemFeedback = allFeedback.filter(f => f.systemName === system.systemName);
            const totalPoints = systemFeedback.reduce((sum, fb) => sum + (fb.rating || 0), 0);
            const feedbackCount = systemFeedback.length;
            
            // Update stats
            document.getElementById('statsContainer').innerHTML = `
                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value">${totalSessions}</div>
                            <div class="stat-label">Total Sessions</div>
                        </div>
                        <div class="stat-icon session">
                            <i class="fas fa-calendar-alt"></i>
                        </div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value">${unlockedSessions}</div>
                            <div class="stat-label">Unlocked Sessions</div>
                        </div>
                        <div class="stat-icon system">
                            <i class="fas fa-lock-open"></i>
                        </div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value">${totalPoints}</div>
                            <div class="stat-label">Total Points</div>
                        </div>
                        <div class="stat-icon points">
                            <i class="fas fa-star"></i>
                        </div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value">${feedbackCount}</div>
                            <div class="stat-label">Feedback Received</div>
                        </div>
                        <div class="stat-icon feedback">
                            <i class="fas fa-comment-alt"></i>
                        </div>
                    </div>
                </div>
            `;
            
            // Load feature buttons with counts
            loadFeatureButtons(system);
            
            renderSessions(system);
        }

        // Load feature buttons with notification counts
        function loadFeatureButtons(system) {
            const allFeedback = JSON.parse(localStorage.getItem('studentFeedback') || '[]');
            const systemFeedback = allFeedback.filter(f => f.systemName === system.systemName);
            
            // Get multiple choice feedback
            const mcFeedback = systemFeedback.filter(f => f.multipleChoice && f.multipleChoice.length > 0);
            
            // Analyze for recommendations
            const recommendations = analyzeForRecommendations(system);
            const recommendationsCount = recommendations.length;
            
            // Calculate feedbacks count (exclude today's feedback to show only "new")
            const today = new Date().toDateString();
            const newFeedbacks = systemFeedback.filter(f => {
                const feedbackDate = new Date(f.submittedAt).toDateString();
                return feedbackDate !== today;
            }).length;
            
            document.getElementById('featuresGrid').innerHTML = `
                <div class="feature-card recommendations" onclick="openRecommendationsModal()">
                    <div class="feature-icon recommendations">
                        <i class="fas fa-lightbulb"></i>
                    </div>
                    <div class="feature-content">
                        <h3>
                            Recommendations
                            ${recommendationsCount > 0 ? `<span class="notification-badge">${recommendationsCount}</span>` : ''}
                        </h3>
                        <p>Get intelligent recommendations based on student feedback patterns and common issues</p>
                        <div class="feature-stats">
                            <span><i class="fas fa-chart-line"></i> ${recommendationsCount} suggestions</span>
                            <span><i class="fas fa-clock"></i> Updated today</span>
                        </div>
                    </div>
                </div>
                
                <div class="feature-card feedbacks" onclick="openFeedbacksModal()">
                    <div class="feature-icon feedbacks">
                        <i class="fas fa-comments"></i>
                    </div>
                    <div class="feature-content">
                        <h3>
                            All Feedbacks
                            ${newFeedbacks > 0 ? `<span class="notification-badge">${newFeedbacks}</span>` : ''}
                        </h3>
                        <p>View all student feedback across all sessions with filtering and search capabilities</p>
                        <div class="feature-stats">
                            <span><i class="fas fa-comment"></i> ${systemFeedback.length} total</span>
                            <span><i class="fas fa-user-graduate"></i> ${getUniqueStudents(systemFeedback).length} students</span>
                        </div>
                    </div>
                </div>
                
                <div class="feature-card multiple-choice" onclick="openMultipleChoiceModal()">
                    <div class="feature-icon multiple-choice">
                        <i class="fas fa-poll"></i>
                    </div>
                    <div class="feature-content">
                        <h3>Multiple Choice Rankings</h3>
                        <p>See which multiple choice options are selected most often by students in feedback</p>
                        <div class="feature-stats">
                            <span><i class="fas fa-list"></i> ${mcFeedback.length} responses</span>
                            <span><i class="fas fa-chart-pie"></i> Statistical analysis</span>
                        </div>
                    </div>
                </div>
            `;
            
            // Update counts in modals
            document.getElementById('recommendationsCount').textContent = recommendationsCount;
            document.getElementById('feedbacksCount').textContent = newFeedbacks;
        }

        // Analyze feedback for recommendations
        function analyzeForRecommendations(system) {
            const allFeedback = JSON.parse(localStorage.getItem('studentFeedback') || '[]');
            const systemFeedback = allFeedback.filter(f => f.systemName === system.systemName);
            
            if (systemFeedback.length === 0) return [];
            
            // Analyze multiple choice patterns
            const mcOptions = {};
            systemFeedback.forEach(feedback => {
                if (feedback.multipleChoice && feedback.multipleChoice.length > 0) {
                    feedback.multipleChoice.forEach(option => {
                        mcOptions[option] = (mcOptions[option] || 0) + 1;
                    });
                }
            });
            
            // Find most common issues
            const sortedOptions = Object.entries(mcOptions).sort((a, b) => b[1] - a[1]);
            
            const recommendations = [];
            
            if (sortedOptions.length > 0) {
                const [topOption, topCount] = sortedOptions[0];
                const totalResponses = systemFeedback.filter(f => f.multipleChoice && f.multipleChoice.length > 0).length;
                const percentage = Math.round((topCount / totalResponses) * 100);
                
                // Generate recommendations based on top issue
                if (topOption.includes('difficult') || topOption.includes('hard') || topOption.includes('challenging')) {
                    recommendations.push({
                        issue: topOption,
                        count: topCount,
                        percentage: percentage,
                        suggestions: [
                            "Consider breaking down complex topics into smaller, more manageable segments",
                            "Provide additional examples and practice problems for difficult concepts",
                            "Schedule extra office hours or review sessions for struggling students",
                            "Create supplementary learning materials or video tutorials"
                        ]
                    });
                } else if (topOption.includes('pace') || topOption.includes('fast') || topOption.includes('slow')) {
                    recommendations.push({
                        issue: topOption,
                        count: topCount,
                        percentage: percentage,
                        suggestions: [
                            "Adjust lecture pace based on weekly feedback check-ins",
                            "Implement quick comprehension checks during sessions",
                            "Provide pre-session materials for students to review ahead of time",
                            "Record sessions for students to review at their own pace"
                        ]
                    });
                } else if (topOption.includes('explanation') || topOption.includes('clear') || topOption.includes('understand')) {
                    recommendations.push({
                        issue: topOption,
                        count: topCount,
                        percentage: percentage,
                        suggestions: [
                            "Use more visual aids and real-world examples in explanations",
                            "Encourage questions and provide multiple explanations for complex topics",
                            "Implement peer teaching moments where students explain concepts to each other",
                            "Provide concise written summaries of key points after each session"
                        ]
                    });
                } else {
                    recommendations.push({
                        issue: topOption,
                        count: topCount,
                        percentage: percentage,
                        suggestions: [
                            "Review session materials and adjust based on this feedback",
                            "Consider different teaching approaches for this topic",
                            "Gather more specific feedback through targeted questions",
                            "Discuss this issue with students to understand their perspective better"
                        ]
                    });
                }
                
                // Add general recommendations based on ratings
                const avgRating = systemFeedback.reduce((sum, f) => sum + f.rating, 0) / systemFeedback.length;
                
                if (avgRating < 3) {
                    recommendations.push({
                        issue: "Low overall ratings",
                        count: systemFeedback.filter(f => f.rating < 3).length,
                        percentage: Math.round((systemFeedback.filter(f => f.rating < 3).length / systemFeedback.length) * 100),
                        suggestions: [
                            "Conduct anonymous mid-course evaluations for detailed feedback",
                            "Implement more interactive elements in your sessions",
                            "Consider adjusting the course structure or content delivery",
                            "Schedule one-on-one check-ins with students to address concerns"
                        ]
                    });
                }
            }
            
            return recommendations;
        }

        // Get unique students from feedback
        function getUniqueStudents(feedbackArray) {
            const students = new Set();
            feedbackArray.forEach(f => {
                if (f.studentReg) {
                    students.add(f.studentReg);
                }
            });
            return Array.from(students);
        }

        // Get session status from localStorage
        function getSessionStatus(systemIndex) {
            const sessionStatus = JSON.parse(localStorage.getItem('sessionStatus') || '{}');
            return sessionStatus[systemIndex] || {};
        }

        // Save session status to localStorage
        function saveSessionStatus(systemIndex, sessionIndex, isUnlocked) {
            const sessionStatus = JSON.parse(localStorage.getItem('sessionStatus') || '{}');
            if (!sessionStatus[systemIndex]) sessionStatus[systemIndex] = {};
            sessionStatus[systemIndex][sessionIndex] = isUnlocked;
            localStorage.setItem('sessionStatus', JSON.stringify(sessionStatus));
        }

        // Initialize ratings line chart
        function initializeRatingsChart(system) {
            const ctx = document.getElementById('ratingsChart').getContext('2d');
            
            const allFeedback = JSON.parse(localStorage.getItem('studentFeedback') || '[]');
            const systemFeedback = allFeedback.filter(f => f.systemName === system.systemName);
            
            const studentRatings = {};
            
            systemFeedback.forEach(feedback => {
                if (!studentRatings[feedback.studentReg]) {
                    studentRatings[feedback.studentReg] = {};
                }
                studentRatings[feedback.studentReg][feedback.sessionIndex] = feedback.rating;
            });
            
            const sessions = system.sessions;
            const students = Object.keys(studentRatings);
            const colors = generateColors(students.length);
            
            const datasets = students.map((student, index) => {
                const dataPoints = sessions.map((session, sessionIndex) => {
                    return studentRatings[student][sessionIndex] || null;
                });
                
                return {
                    label: student,
                    data: dataPoints,
                    borderColor: colors[index],
                    backgroundColor: colors[index] + '20',
                    borderWidth: 2,
                    tension: 0.3,
                    fill: false,
                    pointRadius: 4,
                    pointHoverRadius: 6
                };
            });
            
            if (ratingsChart) {
                ratingsChart.destroy();
            }
            
            ratingsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sessions.map((s, i) => `Session ${i+1}`),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.y}/5`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 5,
                            title: {
                                display: true,
                                text: 'Rating (1-5)'
                            },
                            ticks: {
                                stepSize: 1
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Sessions'
                            }
                        }
                    }
                }
            });
            
            updateChartLegend(students, colors, studentRatings, sessions);
        }

        // Generate distinct colors for charts
        function generateColors(count) {
            const colors = [
                '#4A6FFF', '#00C9B7', '#10B981', '#F59E0B', '#EF4444',
                '#8B5CF6', '#EC4899', '#06B6D4', '#84CC16', '#F97316'
            ];
            
            if (count <= colors.length) {
                return colors.slice(0, count);
            }
            
            const additionalColors = [];
            for (let i = colors.length; i < count; i++) {
                const hue = (i * 137.508) % 360;
                additionalColors.push(`hsl(${hue}, 70%, 60%)`);
            }
            
            return colors.concat(additionalColors);
        }

        // Update chart legend
        function updateChartLegend(students, colors, studentRatings, sessions) {
            const legendContainer = document.getElementById('chartLegend');
            legendContainer.innerHTML = '';
            
            const filter = document.getElementById('chartFilter').value;
            let displaySessions = sessions;
            
            if (filter === 'last5' && sessions.length > 5) {
                displaySessions = sessions.slice(-5);
            } else if (filter === 'last3' && sessions.length > 3) {
                displaySessions = sessions.slice(-3);
            }
            
students.forEach((student, index) => {
    const ratings = Object.values(studentRatings[student] || {});
    const avgRating = ratings.length > 0 
        ? (ratings.reduce((a, b) => a + b, 0) / ratings.length).toFixed(1)
        : 'N/A';
    
    const legendItem = document.createElement('div');
    legendItem.className = 'legend-item';
    legendItem.innerHTML = `
        <div class="legend-color" style="background-color: ${colors[index]}"></div>
        <span class="student-name">${student}</span>
        <span class="rating-value">Avg: ${avgRating}/5</span>
    `;
    legendContainer.appendChild(legendItem);
});
            
            if (students.length === 0) {
                legendContainer.innerHTML = `
                    <div style="text-align: center; width: 100%; color: var(--gray);">
                        <i class="fas fa-chart-line"></i>
                        <p>No student ratings available yet</p>
                    </div>
                `;
            }
        }

        // Update chart based on filter
        function updateChart() {
            if (currentSystemIndex !== null && ratingsChart) {
                const system = ratingSystems[currentSystemIndex];
                initializeRatingsChart(system);
            }
        }

        // Render sessions grid
        function renderSessions(system) {
            const container = document.getElementById('sessionsContainer');
            const status = getSessionStatus(currentSystemIndex);
            
            if (system.sessions.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <div class="empty-icon">
                            <i class="fas fa-calendar-times"></i>
                        </div>
                        <h3>No Sessions Available</h3>
                        <p>This system doesn't have any sessions configured yet.</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            
            system.sessions.forEach((session, index) => {
                const isUnlocked = status[index] === true;
                const sessionFeedback = getSessionFeedback(system.systemName, index);
                const avgRating = sessionFeedback.length > 0 
                    ? (sessionFeedback.reduce((sum, fb) => sum + fb.rating, 0) / sessionFeedback.length).toFixed(1)
                    : 0;
                
                const displaySession = session.length > 30 ? session.substring(0, 30) + '...' : session;
                
                const card = document.createElement('div');
                card.className = `session-card ${isUnlocked ? 'unlocked' : 'locked'}`;
                card.innerHTML = `
                    <div class="session-header">
                        <div>
                            <h3 title="${session}">${displaySession}</h3>
                            <div class="session-number">
                                <i class="fas fa-hashtag"></i>
                                <span>Session ${index + 1}</span>
                            </div>
                        </div>
                        <div class="session-badge ${isUnlocked ? 'unlocked' : 'locked'}" title="${isUnlocked ? 'Session is open for students' : 'Session is closed'}">
                            ${isUnlocked ? '<i class="fas fa-lock-open"></i>' : '<i class="fas fa-lock"></i>'}
                        </div>
                    </div>
                    
                    <div class="session-details">
                        <div class="detail-item">
                            <div class="detail-value">${sessionFeedback.length}</div>
                            <div class="detail-label">Feedbacks</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-value">${avgRating}</div>
                            <div class="detail-label">Avg Rating</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-value">${isUnlocked ? 'Open' : 'Closed'}</div>
                            <div class="detail-label">Status</div>
                        </div>
                    </div>
                    
                    <div class="session-actions">
                        <button class="btn btn-sm btn-unlock" onclick="toggleSession(${index}, true)" ${isUnlocked ? 'disabled' : ''} title="Unlock session for students">
                            <i class="fas fa-lock-open"></i>
                            Unlock
                        </button>
                        <button class="btn btn-sm btn-lock" onclick="toggleSession(${index}, false)" ${!isUnlocked ? 'disabled' : ''} title="Lock session">
                            <i class="fas fa-lock"></i>
                            Lock
                        </button>
                        <button class="btn btn-sm btn-view" onclick="viewSessionFeedback(${index})" title="View student feedback">
                            <i class="fas fa-eye"></i>
                            View
                        </button>
                    </div>
                `;
                
                container.appendChild(card);
            });
        }

        // Get feedback for a specific session
        function getSessionFeedback(systemName, sessionIndex) {
            const allFeedback = JSON.parse(localStorage.getItem('studentFeedback') || '[]');
            return allFeedback.filter(f => f.systemName === systemName && f.sessionIndex === sessionIndex);
        }

        // Toggle session lock/unlock
        function toggleSession(sessionIndex, unlock) {
            const system = ratingSystems[currentSystemIndex];
            const sessionName = system.sessions[sessionIndex];
            
            saveSessionStatus(currentSystemIndex, sessionIndex, unlock);
            showToast(`Session "${sessionName}" ${unlock ? 'unlocked' : 'locked'} successfully`, 'success');
            loadSessionManagement(system);
        }

        // View session feedback
        function viewSessionFeedback(sessionIndex) {
            currentSessionIndex = sessionIndex;
            openFeedbackModal();
        }

        // NEW: Open recommendations modal
        function openRecommendationsModal() {
            const system = ratingSystems[currentSystemIndex];
            const recommendations = analyzeForRecommendations(system);
            
            const content = document.getElementById('recommendationsContent');
            
            if (recommendations.length === 0) {
                content.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px;">
                        <div style="font-size: 48px; color: var(--gray-light); margin-bottom: 20px;">
                            <i class="fas fa-lightbulb"></i>
                        </div>
                        <h3 style="color: var(--secondary); margin-bottom: 10px;">No Recommendations Yet</h3>
                        <p style="color: var(--gray-dark); margin-bottom: 20px;">Once students start providing feedback, you'll see intelligent recommendations here.</p>
                        <button class="btn btn-secondary" onclick="closeRecommendationsModal()">
                            <i class="fas fa-times"></i>
                            Close
                        </button>
                    </div>
                `;
            } else {
                let html = `
                    <div style="margin-bottom: 25px;">
                        <h3 style="font-size: 18px; color: var(--secondary); margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-chart-pie"></i>
                            Feedback Analysis Summary
                        </h3>
                        <div style="background: var(--light); border-radius: var(--radius); padding: 15px; margin-bottom: 20px;">
                            <p style="color: var(--secondary); font-size: 14px; margin-bottom: 10px;">
                                Based on ${recommendations.reduce((sum, r) => sum + r.count, 0)} feedback responses, here are the key areas for improvement:
                            </p>
                        </div>
                    </div>
                `;
                
                recommendations.forEach((rec, index) => {
                    html += `
                        <div class="recommendation-card">
                            <div class="recommendation-header">
                                <i class="fas fa-exclamation-circle"></i>
                                <h3>Issue ${index + 1}: ${rec.issue}</h3>
                            </div>
                            
                            <div class="issue-stats">
                                <h4>Feedback Statistics</h4>
                                <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                                    <div>
                                        <div style="font-size: 24px; font-weight: 700; color: var(--primary);">${rec.count}</div>
                                        <div style="font-size: 12px; color: var(--gray-dark);">Students mentioned</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 24px; font-weight: 700; color: var(--accent);">${rec.percentage}%</div>
                                        <div style="font-size: 12px; color: var(--gray-dark);">Of feedback responses</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 24px; font-weight: 700; color: var(--success);">${index === 0 ? '1st' : (index === 1 ? '2nd' : '3rd')}</div>
                                        <div style="font-size: 12px; color: var(--gray-dark);">Most common issue</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <h4 style="font-size: 16px; color: var(--secondary); margin-bottom: 12px;">Recommended Actions</h4>
                                <div class="recommendations-list">
                                    ${rec.suggestions.map(suggestion => `
                                        <div class="recommendation-item">
                                            <i class="fas fa-check-circle"></i>
                                            <span style="font-size: 14px; color: var(--secondary);">${suggestion}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                content.innerHTML = html;
            }
            
            document.getElementById('recommendationsModal').classList.add('active');
        }

        // NEW: Close recommendations modal
        function closeRecommendationsModal() {
            document.getElementById('recommendationsModal').classList.remove('active');
        }

        // NEW: Open feedbacks modal
        function openFeedbacksModal() {
            const system = ratingSystems[currentSystemIndex];
            const allFeedback = JSON.parse(localStorage.getItem('studentFeedback') || '[]');
            const systemFeedback = allFeedback.filter(f => f.systemName === system.systemName);
            
            const content = document.getElementById('feedbacksContent');
            
            if (systemFeedback.length === 0) {
                content.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px;">
                        <div style="font-size: 48px; color: var(--gray-light); margin-bottom: 20px;">
                            <i class="fas fa-comment-slash"></i>
                        </div>
                        <h3 style="color: var(--secondary); margin-bottom: 10px;">No Feedback Yet</h3>
                        <p style="color: var(--gray-dark); margin-bottom: 20px;">Student feedback will appear here once sessions are unlocked and students submit their ratings.</p>
                        <button class="btn btn-secondary" onclick="closeFeedbacksModal()">
                            <i class="fas fa-times"></i>
                            Close
                        </button>
                    </div>
                `;
            } else {
                // Group feedback by session
                const feedbackBySession = {};
                systemFeedback.forEach(f => {
                    if (!feedbackBySession[f.sessionIndex]) {
                        feedbackBySession[f.sessionIndex] = [];
                    }
                    feedbackBySession[f.sessionIndex].push(f);
                });
                
                let html = `
                    <div class="feedback-summary">
                        <div class="feedback-stats">
                            <div class="feedback-stat-item">
                                <div class="feedback-stat-value">${systemFeedback.length}</div>
                                <div class="feedback-stat-label">Total Feedback</div>
                            </div>
                            <div class="feedback-stat-item">
                                <div class="feedback-stat-value">${getUniqueStudents(systemFeedback).length}</div>
                                <div class="feedback-stat-label">Unique Students</div>
                            </div>
                            <div class="feedback-stat-item">
                                <div class="feedback-stat-value">${system.sessions.length}</div>
                                <div class="feedback-stat-label">Sessions</div>
                            </div>
                            <div class="feedback-stat-item">
                                <div class="feedback-stat-value">${(systemFeedback.reduce((sum, f) => sum + f.rating, 0) / systemFeedback.length).toFixed(1)}</div>
                                <div class="feedback-stat-label">Avg Rating</div>
                            </div>
                        </div>
                        
                        <div class="feedback-filters">
                            <button class="filter-btn active" onclick="filterFeedback('all')">All</button>
                            <button class="filter-btn" onclick="filterFeedback('positive')">Positive (4-5 stars)</button>
                            <button class="filter-btn" onclick="filterFeedback('neutral')">Neutral (3 stars)</button>
                            <button class="filter-btn" onclick="filterFeedback('negative')">Needs Improvement (1-2 stars)</button>
                            <button class="filter-btn" onclick="filterFeedback('recent')">Most Recent</button>
                        </div>
                    </div>
                    
                    <div id="feedbackItems" style="max-height: 500px; overflow-y: auto; padding-right: 10px;">
                `;
                
                // Sort feedback by date (newest first)
                const sortedFeedback = [...systemFeedback].sort((a, b) => 
                    new Date(b.submittedAt) - new Date(a.submittedAt)
                );
                
                sortedFeedback.forEach(feedback => {
                    const sessionName = system.sessions[feedback.sessionIndex] || `Session ${feedback.sessionIndex + 1}`;
                    const stars = ''.repeat(feedback.rating) + ''.repeat(5 - feedback.rating);
                    const date = new Date(feedback.submittedAt).toLocaleString();
                    
                    let ratingClass = 'neutral';
                    if (feedback.rating >= 4) ratingClass = 'positive';
                    else if (feedback.rating <= 2) ratingClass = 'negative';
                    
                    html += `
                        <div class="feedback-item" data-rating="${ratingClass}">
                            <div class="feedback-session">${sessionName}</div>
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                <div>
                                    <div style="font-weight: 600; color: var(--secondary); margin-bottom: 4px;">${feedback.studentReg}</div>
                                    <div style="font-size: 12px; color: var(--gray-dark);">
                                        <i class="far fa-clock"></i> ${date}
                                    </div>
                                </div>
                                <div style="color: #FF9529; font-weight: 700;">
                                    ${stars} (${feedback.rating}/5)
                                </div>
                            </div>
                            <div style="color: var(--secondary); font-size: 14px; line-height: 1.5;">
                                ${feedback.feedback || '<em style="color: var(--gray);">No written feedback provided</em>'}
                            </div>
                            ${feedback.multipleChoice && feedback.multipleChoice.length > 0 ? `
                                <div style="margin-top: 10px;">
                                    <div style="font-size: 12px; color: var(--gray-dark); margin-bottom: 5px;">Multiple Choice Selections:</div>
                                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                        ${feedback.multipleChoice.map(option => `
                                            <span style="background: var(--primary); color: white; padding: 3px 8px; border-radius: 12px; font-size: 11px;">
                                                ${option}
                                            </span>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
                
                html += `</div>`;
                content.innerHTML = html;
            }
            
            document.getElementById('feedbacksModal').classList.add('active');
        }

        // NEW: Filter feedback
        function filterFeedback(type) {
            const items = document.querySelectorAll('#feedbackItems .feedback-item');
            const buttons = document.querySelectorAll('.filter-btn');
            
            buttons.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            items.forEach(item => {
                const rating = item.getAttribute('data-rating');
                const isVisible = 
                    type === 'all' ||
                    (type === 'positive' && rating === 'positive') ||
                    (type === 'neutral' && rating === 'neutral') ||
                    (type === 'negative' && rating === 'negative') ||
                    (type === 'recent' && item.querySelector('[data-recent]'));
                
                item.style.display = isVisible ? 'block' : 'none';
            });
        }

        // NEW: Close feedbacks modal
        function closeFeedbacksModal() {
            document.getElementById('feedbacksModal').classList.remove('active');
        }

        // NEW: Open multiple choice modal
        function openMultipleChoiceModal() {
            const system = ratingSystems[currentSystemIndex];
            const allFeedback = JSON.parse(localStorage.getItem('studentFeedback') || '[]');
            const systemFeedback = allFeedback.filter(f => f.systemName === system.systemName);
            
            const content = document.getElementById('multipleChoiceContent');
            
            // Get all multiple choice options with counts
            const mcOptions = {};
            systemFeedback.forEach(feedback => {
                if (feedback.multipleChoice && feedback.multipleChoice.length > 0) {
                    feedback.multipleChoice.forEach(option => {
                        mcOptions[option] = (mcOptions[option] || 0) + 1;
                    });
                }
            });
            
            if (Object.keys(mcOptions).length === 0) {
                content.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px;">
                        <div style="font-size: 48px; color: var(--gray-light); margin-bottom: 20px;">
                            <i class="fas fa-poll"></i>
                        </div>
                        <h3 style="color: var(--secondary); margin-bottom: 10px;">No Multiple Choice Data</h3>
                        <p style="color: var(--gray-dark); margin-bottom: 20px;">Multiple choice selections will appear here once students start using this feature.</p>
                        <button class="btn btn-secondary" onclick="closeMultipleChoiceModal()">
                            <i class="fas fa-times"></i>
                            Close
                        </button>
                    </div>
                `;
            } else {
                // Sort options by count
                const sortedOptions = Object.entries(mcOptions).sort((a, b) => b[1] - a[1]);
                const totalSelections = sortedOptions.reduce((sum, [option, count]) => sum + count, 0);
                const maxCount = sortedOptions[0][1];
                
                let html = `
                    <div style="margin-bottom: 25px;">
                        <h3 style="font-size: 18px; color: var(--secondary); margin-bottom: 10px;">
                            <i class="fas fa-chart-bar"></i>
                            Multiple Choice Feedback Analysis
                        </h3>
                        <p style="color: var(--gray-dark); font-size: 14px; margin-bottom: 15px;">
                            Based on ${totalSelections} selections from ${systemFeedback.filter(f => f.multipleChoice && f.multipleChoice.length > 0).length} students
                        </p>
                    </div>
                    
                    <div class="ranking-chart">
                `;
                
                sortedOptions.forEach(([option, count], index) => {
                    const percentage = Math.round((count / totalSelections) * 100);
                    const widthPercentage = (count / maxCount) * 100;
                    
                    let positionClass = '';
                    if (index === 0) positionClass = 'gold';
                    else if (index === 1) positionClass = 'silver';
                    else if (index === 2) positionClass = 'bronze';
                    
                    html += `
                        <div class="ranking-item">
                            <div class="ranking-position ${positionClass}">${index + 1}</div>
                            <div class="ranking-content">
                                <div class="ranking-bar">
                                    <div class="ranking-fill" style="width: ${widthPercentage}%; background-color: ${getRankingColor(index)};"></div>
                                </div>
                                <div class="ranking-info">
                                    <span>${option}</span>
                                    <span>${count} selections (${percentage}%)</span>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += `</div>`;
                
                // Add insights
                const topOption = sortedOptions[0][0];
                const topCount = sortedOptions[0][1];
                const topPercentage = Math.round((topCount / totalSelections) * 100);
                
                html += `
                    <div style="background: linear-gradient(135deg, rgba(74, 111, 255, 0.1) 0%, rgba(74, 111, 255, 0.05) 100%); border-radius: var(--radius); padding: 20px; margin-top: 25px;">
                        <h4 style="font-size: 16px; color: var(--secondary); margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-chart-line"></i>
                            Key Insight
                        </h4>
                        <p style="color: var(--secondary); font-size: 14px; line-height: 1.5;">
                            <strong>"${topOption}"</strong> is the most selected option, chosen by ${topPercentage}% of students. 
                            This indicates that ${getInsightForOption(topOption)}.
                        </p>
                    </div>
                `;
                
                content.innerHTML = html;
            }
            
            document.getElementById('multipleChoiceModal').classList.add('active');
        }

        // NEW: Get ranking color based on position
        function getRankingColor(index) {
            const colors = [
                '#4A6FFF', // Blue for 1st
                '#00C9B7', // Teal for 2nd
                '#10B981', // Green for 3rd
                '#F59E0B', // Orange for 4th
                '#EF4444'  // Red for 5th
            ];
            return colors[Math.min(index, colors.length - 1)];
        }

        // NEW: Get insight for option
        function getInsightForOption(option) {
            if (option.includes('difficult') || option.includes('hard') || option.includes('challenging')) {
                return "students find this aspect particularly challenging and may need additional support";
            } else if (option.includes('pace') || option.includes('fast') || option.includes('slow')) {
                return "the pace of instruction is a primary concern for many students";
            } else if (option.includes('explanation') || option.includes('clear') || option.includes('understand')) {
                return "clarity of explanations is a significant factor in student learning";
            } else if (option.includes('interesting') || option.includes('engaging') || option.includes('boring')) {
                return "engagement levels are a key area of student feedback";
            } else if (option.includes('helpful') || option.includes('support') || option.includes('resources')) {
                return "students value the support and resources provided";
            } else {
                return "this is a key area of student feedback that warrants attention";
            }
        }

        // NEW: Close multiple choice modal
        function closeMultipleChoiceModal() {
            document.getElementById('multipleChoiceModal').classList.remove('active');
        }

        // Open feedback modal
        function openFeedbackModal() {
            const system = ratingSystems[currentSystemIndex];
            
            const tabsContainer = document.getElementById('sessionTabs');
            tabsContainer.innerHTML = '';
            
            system.sessions.forEach((session, index) => {
                const tab = document.createElement('button');
                tab.className = `session-tab ${index === currentSessionIndex ? 'active' : ''}`;
                const tabText = session.length > 15 ? session.substring(0, 15) + '...' : session;
                tab.textContent = `${index + 1}. ${tabText}`;
                tab.title = session;
                tab.onclick = () => {
                    currentSessionIndex = index;
                    loadFeedbackForSession(index);
                    document.querySelectorAll('.session-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                };
                tabsContainer.appendChild(tab);
            });
            
            loadFeedbackForSession(currentSessionIndex);
            document.getElementById('feedbackModal').classList.add('active');
        }

        // Load feedback for a specific session
        function loadFeedbackForSession(sessionIndex) {
            const system = ratingSystems[currentSystemIndex];
            const feedback = getSessionFeedback(system.systemName, sessionIndex);
            const replies = JSON.parse(localStorage.getItem('instructorReplies') || '{}');
            
            const content = document.getElementById('feedbackContent');
            
            if (feedback.length === 0) {
                content.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="fas fa-comment-slash"></i>
                        </div>
                        <h3>No Feedback Yet</h3>
                        <p>No students have submitted feedback for this session yet.</p>
                    </div>
                `;
                return;
            }
            
            const totalPoints = feedback.reduce((sum, fb) => sum + fb.rating, 0);
            const avgRating = (totalPoints / feedback.length).toFixed(1);
            
            const topStudents = [...feedback]
                .sort((a, b) => b.rating - a.rating)
                .slice(0, 5)
                .map(fb => `${fb.studentReg} (${fb.rating}/5)`);
            
            let html = `
                <div style="margin-bottom: 20px; display: flex; gap: 15px; flex-wrap: wrap;">
                    <div style="background: var(--light); padding: 12px; border-radius: var(--radius-sm); min-width: 120px;">
                        <div style="font-size: 11px; color: var(--gray); margin-bottom: 4px;">Total Feedback</div>
                        <div style="font-size: 20px; font-weight: 700; color: var(--primary);">${feedback.length}</div>
                    </div>
                    <div style="background: var(--light); padding: 12px; border-radius: var(--radius-sm); min-width: 120px;">
                        <div style="font-size: 11px; color: var(--gray); margin-bottom: 4px;">Average Rating</div>
                        <div style="font-size: 20px; font-weight: 700; color: var(--accent);">${avgRating}/5.0</div>
                    </div>
                    <div style="background: var(--light); padding: 12px; border-radius: var(--radius-sm); min-width: 120px;">
                        <div style="font-size: 11px; color: var(--gray); margin-bottom: 4px;">Total Points</div>
                        <div style="font-size: 20px; font-weight: 700; color: var(--success);">${totalPoints}</div>
                    </div>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <div style="font-size: 14px; font-weight: 600; color: var(--secondary); margin-bottom: 8px;">
                        <i class="fas fa-crown"></i> Top Students in This Session
                    </div>
                    <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                        ${topStudents.map(student => `
                            <div style="background: var(--primary); color: white; padding: 6px 12px; border-radius: 20px; font-size: 12px;">
                                ${student}
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div style="margin-bottom: 15px; height: 150px;">
                    <canvas id="feedbackChart" height="150"></canvas>
                </div>
                
                <div class="feedback-list">
            `;
            
            feedback.forEach((fb, fbIndex) => {
                const feedbackId = `${currentSystemIndex}-${sessionIndex}-${fb.studentReg}`;
                const feedbackReplies = replies[feedbackId] || [];
                
                const stars = ''.repeat(fb.rating) + ''.repeat(5 - fb.rating);
                
                html += `
                    <div class="feedback-item">
                        <div class="feedback-header">
                            <span class="feedback-student">${fb.studentReg}</span>
                            <span class="feedback-rating">${stars} (${fb.rating}/5)</span>
                        </div>
                        <div class="feedback-date">
                            <i class="far fa-clock"></i> ${new Date(fb.submittedAt).toLocaleString()}
                        </div>
                        <div class="feedback-text">${fb.feedback || 'No written feedback provided'}</div>
                        
                        ${feedbackReplies.length > 0 ? `
                            <div class="reply-section">
                                <div style="font-size: 13px; color: var(--secondary); margin-bottom: 8px; font-weight: 600;">
                                    <i class="fas fa-reply"></i> Instructor Replies (${feedbackReplies.length})
                                </div>
                        ` : ''}
                        
                        ${feedbackReplies.map(reply => `
                            <div class="reply-item">
                                <div class="reply-header">
                                    <i class="fas fa-user-tie"></i> ${reply.instructorName || currentInstructor.name}
                                </div>
                                <div class="reply-text">${reply.reply}</div>
                                <div class="reply-date">
                                    ${new Date(reply.repliedAt).toLocaleString()}
                                </div>
                            </div>
                        `).join('')}
                        
                        ${feedbackReplies.length > 0 ? `</div>` : ''}
                        
                        <div style="margin-top: 10px;">
                            <button class="btn btn-sm" onclick="showReplyForm(${fbIndex})" style="background: var(--light); padding: 5px 10px;">
                                <i class="fas fa-reply"></i> Reply
                            </button>
                        </div>
                        
                        <div id="reply-form-${fbIndex}" class="reply-form">
                            <textarea class="reply-textarea" id="reply-text-${fbIndex}" placeholder="Type your reply to ${fb.studentReg}..."></textarea>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-sm btn-primary" onclick="sendReply(${sessionIndex}, ${fbIndex}, '${fb.studentReg}')" style="padding: 6px 12px;">
                                    <i class="fas fa-paper-plane"></i> Send
                                </button>
                                <button class="btn btn-sm btn-secondary" onclick="hideReplyForm(${fbIndex})" style="padding: 6px 12px;">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += `</div>`;
            content.innerHTML = html;
            
            drawFeedbackChart(feedback);
        }

        // Draw feedback chart
        function drawFeedbackChart(feedback) {
            const canvas = document.getElementById('feedbackChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            const ratingCounts = {1: 0, 2: 0, 3: 0, 4: 0, 5: 0};
            feedback.forEach(fb => {
                if (fb.rating >= 1 && fb.rating <= 5) {
                    ratingCounts[fb.rating]++;
                }
            });
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['1 Star', '2 Stars', '3 Stars', '4 Stars', '5 Stars'],
                    datasets: [{
                        label: 'Number of Ratings',
                        data: [ratingCounts[1], ratingCounts[2], ratingCounts[3], ratingCounts[4], ratingCounts[5]],
                        backgroundColor: [
                            'rgba(239, 68, 68, 0.7)',
                            'rgba(245, 158, 11, 0.7)',
                            'rgba(250, 204, 21, 0.7)',
                            'rgba(132, 204, 22, 0.7)',
                            'rgba(16, 185, 129, 0.7)'
                        ],
                        borderColor: [
                            'rgb(239, 68, 68)',
                            'rgb(245, 158, 11)',
                            'rgb(250, 204, 21)',
                            'rgb(132, 204, 22)',
                            'rgb(16, 185, 129)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1,
                                font: {
                                    size: 10
                                }
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    size: 10
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // Show reply form
        function showReplyForm(fbIndex) {
            document.querySelectorAll('.reply-form').forEach(form => {
                form.style.display = 'none';
            });
            
            const form = document.getElementById(`reply-form-${fbIndex}`);
            if (form) {
                form.style.display = 'block';
                form.querySelector('textarea').focus();
            }
        }

        // Hide reply form
        function hideReplyForm(fbIndex) {
            const form = document.getElementById(`reply-form-${fbIndex}`);
            if (form) {
                form.style.display = 'none';
                form.querySelector('textarea').value = '';
            }
        }

        // Send reply to student feedback
        function sendReply(sessionIndex, fbIndex, studentReg) {
            const replyText = document.getElementById(`reply-text-${fbIndex}`).value.trim();
            
            if (!replyText) {
                showToast('Please enter a reply message', 'error');
                return;
            }
            
            const feedbackId = `${currentSystemIndex}-${sessionIndex}-${studentReg}`;
            const replies = JSON.parse(localStorage.getItem('instructorReplies') || '{}');
            
            if (!replies[feedbackId]) replies[feedbackId] = [];
            
            replies[feedbackId].push({
                instructorName: currentInstructor.name,
                reply: replyText,
                repliedAt: new Date().toISOString()
            });
            
            localStorage.setItem('instructorReplies', JSON.stringify(replies));
            
            document.getElementById(`reply-text-${fbIndex}`).value = '';
            hideReplyForm(fbIndex);
            
            loadFeedbackForSession(currentSessionIndex);
            showToast('Reply sent successfully!', 'success');
        }

        // Close feedback modal
        function closeFeedbackModal() {
            document.getElementById('feedbackModal').classList.remove('active');
        }

        // Refresh data
        function refreshData() {
            if (currentSystemIndex !== null) {
                const system = ratingSystems[currentSystemIndex];
                loadSessionManagement(system);
                initializeRatingsChart(system);
                showToast('Data refreshed successfully', 'success');
            }
        }

        // Complete logout (from sidebar)
        function logoutInstructor() {
            if (confirm('Are you sure you want to logout completely?')) {
                currentInstructor = null;
                currentSystemIndex = null;
                sessionStorage.removeItem('instructorSession');
                localStorage.removeItem(CURRENT_SESSION_KEY);
                
                document.getElementById('instructorName').textContent = 'Not Logged In';
                document.getElementById('instructorRole').textContent = 'Select System';
                document.getElementById('profilePicture').src = 'default-instructor.png';
                
                showLoginInterface();
                
                if (ratingsChart) {
                    ratingsChart.destroy();
                    ratingsChart = null;
                }
                
                showToast('Logged out successfully', 'success');
            }
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                if (document.getElementById('recommendationsModal').classList.contains('active')) {
                    closeRecommendationsModal();
                } else if (document.getElementById('feedbacksModal').classList.contains('active')) {
                    closeFeedbacksModal();
                } else if (document.getElementById('multipleChoiceModal').classList.contains('active')) {
                    closeMultipleChoiceModal();
                } else if (document.getElementById('feedbackModal').classList.contains('active')) {
                    closeFeedbackModal();
                }
            }
            
            if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
                e.preventDefault();
                refreshData();
            }
            
            if ((e.ctrlKey || e.metaKey) && e.key === 'l') {
                e.preventDefault();
                logoutCurrentSystem();
            }
        });
    </script>
</body>
</html>